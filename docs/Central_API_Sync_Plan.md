# Central API Synchronization Development Plan

This document outlines the contract for the Edge Node's synchronization with the Central API, which will be developed using ASP.NET Core API. It details the required API endpoints, the data formats for requests and responses, and the authentication mechanism.

## 1. Authentication and Security

The Edge Node uses **Mutual TLS (mTLS)** for secure and authenticated communication with the Central API. This provides both encryption and client authentication, ensuring only provisioned Edge Nodes can access the API.

| Detail | Specification |
| :--- | :--- |
| **Mechanism** | Mutual TLS (mTLS) |
| **Client Identity** | A unique client certificate (`client.crt`) and key (`client.key`) provisioned to each Edge Node. |
| **Server Identity** | The Central API must present a valid server certificate signed by a trusted CA (`ca.crt`). |
| **Configuration** | The Edge Node is configured with the paths to these files in `config/config.yaml` under the `network.cert_paths` section. |
| **Fallback** | If `network.use_mtls` is set to `false` (e.g., for local testing), the API should fall back to standard HTTPS/TLS, relying on other security measures (e.g., IP whitelisting). |

**ASP.NET Core Implementation Note:** The API must be configured to require and validate client certificates for all endpoints listed below.

## 2. API Endpoints Contract

The Edge Node interacts with the Central API via three primary functions: **Clip Upload**, **Model/KB Sync**, and **Heartbeat/Control** (via MQTT, which is not covered here).

### 2.1. Clip Upload Flow

The upload process is a three-step sequence designed to handle large files efficiently using presigned URLs.

#### Endpoint 1: Request Presigned Upload URL

| Detail | Specification |
| :--- | :--- |
| **Method** | `POST` |
| **Path** | `/api/v1/upload-request` |
| **Purpose** | Request a temporary, time-limited URL for direct file upload to a storage service (e.g., S3, Azure Blob). |

**Request Body (JSON):**

```json
{
  "event_id": "evt-20251116-0001",
  "filename": "evt-20251116-0001.mp4",
  "content_type": "video/mp4",
  "checksum_sha256": "a1b2c3d4e5f6...",
  "tenant_id": "acme",
  "device_id": "thor-mini-001"
}
```

**Response Body (JSON - 200 OK):**

```json
{
  "upload_id": "upload-evt-20251116-0001",
  "upload_url": "https://s3.example.com/bucket/path?AWSAccessKeyId=...",
  "final_url": "https://cdn.example.com/acme/thor-mini-001/evt-20251116-0001.mp4"
}
```

**Intermediate Step: File Upload**

The Edge Node will then perform a `PUT` request to the `upload_url` with the raw file content. The Central API is not directly involved in this step but must ensure the `upload_url` is valid and accessible.

#### Endpoint 2: Notify Upload Completion

| Detail | Specification |
| :--- | :--- |
| **Method** | `POST` |
| **Path** | `/api/v1/upload-complete` |
| **Purpose** | Notify the Central API that the file upload to the storage service is complete. |

**Request Body (JSON):**

```json
{
  "upload_id": "upload-evt-20251116-0001",
  "checksum_sha256": "a1b2c3d4e5f6...",
  "final_url": "https://cdn.example.com/acme/thor-mini-001/evt-20251116-0001.mp4"
}
```

**Response Body (JSON - 200 OK):**

```json
{
  "message": "Upload completion acknowledged"
}
```

#### Endpoint 3: Post Event Metadata

| Detail | Specification |
| :--- | :--- |
| **Method** | `POST` |
| **Path** | `/api/v1/metadata` |
| **Purpose** | Submit the final, complete event metadata, including the public URL of the uploaded clip. |

**Request Body (JSON):**

This is the full event object generated by the `vss_aggregator`, with the addition of the `clip_url`.

```json
{
  "tenant_id": "acme",
  "device_id": "thor-mini-001",
  "camera_id": "cam-01",
  "event_id": "evt-20251116-0001",
  "timestamp": "2025-11-16T10:02:30Z",
  "event_type": "motion",
  "objects": [
    {"box": [100, 200, 300, 400], "label": "person", "confidence": 0.95}
  ],
  "dense_caption": "A person walked past the gate.",
  "audio_text": "No audio detected.",
  "confidence": 0.9,
  "clip_url": "https://cdn.example.com/acme/thor-mini-001/evt-20251116-0001.mp4"
}
```

**Response Body (JSON - 200 OK):**

```json
{
  "message": "Metadata received and processed"
}
```

### 2.2. Model and Knowledge Base (KB) Synchronization

The `vss_sync` service polls these endpoints to keep the Edge Node's local models and KB up-to-date.

#### Endpoint 4: Poll Training Packages

| Detail | Specification |
| :--- | :--- |
| **Method** | `GET` |
| **Path** | `/api/v1/training-packages` |
| **Purpose** | Check for new or updated CV model packages. |
| **Query Param** | `since`: (Optional) The current model version on the Edge Node. |

**Response Body (JSON - 200 OK):**

An array of package manifests. If no new packages are available, an empty array is returned.

```json
[
  {
    "id": "mock-detector",
    "version": "v2.0",
    "download_url": "https://api.example.com/packages/mock-detector-v2.0.tar.gz",
    "sha256": "f0e1d2c3b4a5...",
    "signature": "mock-signature-12345..."
  }
]
```

#### Endpoint 5: Poll Knowledge Base Manifest

| Detail | Specification |
| :--- | :--- |
| **Method** | `GET` |
| **Path** | `/api/v1/knowledge/manifest` |
| **Purpose** | Check for the latest version of the Knowledge Base delta package. |

**Response Body (JSON - 200 OK):**

```json
{
  "kb_version": "20251116.1",
  "delta_package_url": "https://api.example.com/kb/kb-delta-20251116.1.zip"
}
```

The Edge Node will compare `kb_version` with its local version. If newer, it will download the file from `delta_package_url` and apply the changes to its local SQLite KB.

## 3. Error Handling

The Central API should adhere to standard HTTP status codes:

| Status Code | Edge Node Action |
| :--- | :--- |
| **200 OK** | Success. Proceed to the next step. |
| **400 Bad Request** | Fatal error (e.g., malformed JSON). Log and mark upload as `FAILED`. |
| **401 Unauthorized** | Authentication failure (e.g., mTLS certificate rejected). Log and mark upload as `FAILED`. |
| **404 Not Found** | Endpoint or resource not found. Log and mark upload as `FAILED`. |
| **409 Conflict** | Resource already exists (e.g., duplicate `event_id`). Log and mark upload as `FAILED`. |
| **5xx Server Error** | Transient server-side error. Log and trigger **exponential backoff retry** (up to `upload.max_retries` times). |
